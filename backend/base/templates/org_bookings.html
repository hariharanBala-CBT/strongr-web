{% extends "base_org.html" %}
{% load static %}

{% block content %}
<link href="{% static './css/booking.css' %}" rel="stylesheet" />

<div class="container-fluid px-4 py-5">
  <div class="row gx-5 gy-5">
    <div class="col-12">
      <div class="dashboard-header text-center mb-5">
        <h1 class="display-4 fw-bold">Bookings Dashboard</h1>
        <p class="lead">Efficiently manage your bookings with our intuitive interface.</p>
      </div>
    </div>

    <div class="col-12">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-white">
          <h5 class="card-title mb-0"><i class="fas fa-calendar-check me-2"></i>Bookings</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>#</th>
                  <th>Booking Name</th>
                  <th>Court</th>
                  <th>Game</th>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Amount</th>
                  <th>Payment</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="bookingTable">
                {% for booking in bookings %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ booking.name }}</td>
                  <td>{{ booking.court.name }}</td>
                  <td>{{ booking.court.game.game_type.game_name }}</td>
                  <td>{{ booking.booking_date|date:"Y-m-d" }}</td>
                  <td>{{ booking.slot }}</td>
                  <td>{{ booking.total_price }}</td>
                  <td>
                    <span class="badge rounded-pill
                        {% if booking.payment_status == 4 %}bg-success
                        {% elif booking.payment_status == 5 %}bg-danger
                        {% elif booking.payment_status == 2 %}bg-warning text-dark
                        {% else %}bg-secondary{% endif %}">
                      {{ booking.get_payment_status_display }}
                    </span>
                  </td>
                  <td>
                    <span class="badge rounded-pill
                        {% if booking.booking_status == 4 %}bg-success
                        {% elif booking.booking_status == 3 %}bg-danger
                        {% elif booking.booking_status == 2 %}bg-warning text-dark
                        {% else %}bg-secondary{% endif %}">
                      {{ booking.get_booking_status_display }}
                    </span>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        <div class="card-footer bg-white">
          <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mb-0" id="pagination">
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>
  
  <div class="footer py-4 bg-light mt-auto">
    <div class="container-fluid px-4">
      <div class="d-flex align-items-center justify-content-between small">
        <div class="text-muted">Copyright &copy; <span id="current-year"></span> STRONGR. | All Rights Reserved</div>
        <div>
          <a href="{% url 'privacypolicy' %}">Privacy Policy</a>
          &middot;
          <a href="{% url 'termsandconditions' %}">Terms &amp; Conditions</a>
        </div>
      </div>
    </div>
  </div>

<!-- Floating Filter Button -->
<button id="filterButton" class="btn btn-primary rounded-circle position-fixed bottom-0 end-0 m-4 p-3 shadow-lg">
  <i class="fas fa-filter"></i>
</button>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="filterModalLabel">Filter Bookings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="filterForm">
          <div class="mb-3">
            <label for="game" class="form-label">Game Type:</label>
            <select id="game" class="form-select">
              <option value="">All Games</option>
              {% for game in games %}
              <option value="{{ game.game_name }}">{{ game.game_name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label for="first_date" class="form-label">Date:</label>
            <input type="date" id="first_date" class="form-control">
            <small id="start-date-error" class="text-danger"></small>
          </div>

          <div class="mb-3">
            <label for="payment_status" class="form-label">Payment Status:</label>
            <select id="payment_status" class="form-select">
              <option value="">All Status</option>
              {% for value, label in payment_status_choices %}
              <option value="{{ value }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
        <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">Clear Filters</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  window.addEventListener('DOMContentLoaded', event => {
            const $sidebarToggle = document.body.querySelector('#sidebarToggle');
            if ($sidebarToggle) {
                if (localStorage.getItem('sb|sidebar-toggle') === 'true') {
                    document.body.classList.toggle('sb-sidenav-toggled');
                }
                $sidebarToggle.addEventListener('click', event => {
                    event.preventDefault();
                    document.body.classList.toggle('sb-sidenav-toggled');
                    localStorage.setItem('sb|sidebar-toggle', document.body.classList.contains('sb-sidenav-toggled'));
                });
            }
        });

  document.addEventListener('DOMContentLoaded', function () {
    const filterButton = document.getElementById('filterButton');
    const filterModal = new bootstrap.Modal(document.getElementById('filterModal'));

    filterButton.addEventListener('click', function () {
      filterModal.show();
    });

    // Existing pagination and filter logic
    removeStartDateMinAttribute();

    // Pagination variables
    const itemsPerPage = 10;
    let currentPage = 1;
    const rows = Array.from(document.querySelectorAll('#bookingTable tr'));
    let filteredRows = rows;
    let totalPages = Math.ceil(rows.length / itemsPerPage);

    function removeStartDateMinAttribute() {
      const startDateInput = document.getElementById('first_date');
      if (startDateInput) {
        startDateInput.removeAttribute('min');
      }
    }

    function showPage(page) {
      const start = (page - 1) * itemsPerPage;
      const end = start + itemsPerPage;

      filteredRows.forEach((row, index) => {
        if (index >= start && index < end) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }

    function setupPagination() {
      const paginationElement = document.getElementById('pagination');
      paginationElement.innerHTML = '';

      totalPages = Math.ceil(filteredRows.length / itemsPerPage);

      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.classList.add('page-item');
        const a = document.createElement('a');
        a.classList.add('page-link');
        a.href = '#';
        a.textContent = i;

        if (i === currentPage) {
          li.classList.add('active');
        }

        a.addEventListener('click', (e) => {
          e.preventDefault();
          currentPage = i;
          showPage(currentPage);
          setupPagination();
        });

        li.appendChild(a);
        paginationElement.appendChild(li);
      }
    }

    window.applyFilters = function () {
      const game = document.getElementById('game').value;
      const startDate = document.getElementById('first_date').value;
      const paymentStatus = document.getElementById('payment_status').value;

      const startDateError = document.getElementById('start-date-error');

      startDateError.textContent = '';

      filteredRows = rows.filter(row => {
        const gameCell = row.cells[3].innerText.trim();
        const bookingDateStr = row.cells[4].innerText.trim();
        const paymentStatusCell = row.cells[7].innerText.trim();

        // Parse the booking date string to a Date object
        const bookingDate = new Date(bookingDateStr);

        // Adjust for timezone offset
        const bookingDateAdjusted = new Date(bookingDate.getTime() - bookingDate.getTimezoneOffset() * 60000);

        // Format the adjusted date as YYYY-MM-DD for comparison
        const bookingDateFormatted = bookingDateAdjusted.toISOString().split('T')[0];

        if (game && !gameCell.includes(game)) {
          return false;
        }

        if (startDate && bookingDateFormatted < startDate) {
          return false;
        }

        if (startDate && bookingDateFormatted > startDate) {
          return false;
        }

        if (paymentStatus && !paymentStatusCell.includes(paymentStatus)) {
          return false;
        }

        return true;
      });

      // After applying filters, reset pagination
      currentPage = 1;
      showPage(currentPage);
      setupPagination();

      // Hide all rows initially
      rows.forEach(row => row.style.display = 'none');

      // Show only filtered rows
      filteredRows.forEach(row => row.style.display = '');

      // Close the modal after applying filters
      filterModal.hide();
    }

    window.clearFilters = function () {
      document.getElementById('game').value = '';
      document.getElementById('first_date').value = '';
      document.getElementById('payment_status').value = '';

      filteredRows = rows;
      rows.forEach(row => row.style.display = '');

      // After clearing filters, reset pagination
      currentPage = 1;
      showPage(currentPage);
      setupPagination();

      // Close the modal after clearing filters
      filterModal.hide();
    };

    // Initial setup
    showPage(currentPage);
    setupPagination();
  });
</script>
<!-- {% endblock %} -->